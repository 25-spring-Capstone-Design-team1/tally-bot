# Tally Bot Chatbot Frontend

## 개요 🌟

이 프로젝트는 사용자의 메신저 대화를 백엔드 서버와 연동하여 정산을 처리하는 **챗봇 프론트엔드 스크립트**입니다. 사용자가 대화방에서 나누는 대화를 실시간으로 서버에 기록하고, 특정 키워드나 명령어를 통해 정산 기능을 호출합니다. API Backend로부터 AI Core Service를 이용한 정산 결과를 받아 사용자에게 최종 요약 정보를 제공하는 역할을 담당합니다.

## 주요 기능 ✨

💬 **실시간 대화 업로드**: 사용자의 모든 채팅을 인식하여 백엔드 서버(`api/chat/upload`)로 전송 및 저장합니다.
🤖 **키워드 기반 정산 요청**: 사용자가 메시지에 `n월 m일`과 같은 날짜 패턴과 함께 '정산'을 언급하면, 이를 감지하여 정산 명령으로 자동 변환합니다.
⌨️ **명령어 기반 정산 실행**: ``;정산 [시작일] [종료일]`` 형식의 명령어를 통해 특정 기간의 정산을 명시적으로 요청할 수 있습니다.
🔄 **비동기 결과 처리**: 정산 요청 후, 백엔드 서버의 작업이 완료될 때까지 주기적으로 결과 API(`api/calculate/{calculateId}/brief-result`)를 확인(Polling)하고 사용자에게 진행 상황을 알립니다.
📊 **정산 결과 브리핑**: 정산이 완료되면 누가 누구에게 얼마를 보내야 하는지에 대한 요약 정보와 상세 내역을 확인할 수 있는 링크를 채팅방에 회신합니다.
👥 **자동 그룹/멤버 관리**: 사용자가 메시지를 보내면 해당 채팅방과 사용자 정보를 백엔드 서버(`api/group/create`)에 자동으로 등록 및 관리하여 별도의 가입 절차가 필요 없습니다.

## 설치 및 실행 방법 🚀

본 코드는 독립적으로 실행되는 애플리케이션이 아닌, 카카오톡 메시지를 제어하는 비공식 API인 **메신저봇R**에서 동작하는 스크립트입니다.

**환경 설정**

* 메신저봇R(https://download.msgbot.app)을 안드로이드 기기에 설치합니다.

**실행 방법**

1.  메신저봇R에서 새 봇을 추가합니다. 이 때, 레거시 API 사용 옵션을 해제해야 합니다.
2.  연필 모양 버튼을 누르면 코드 입력창으로 진입하는데, 여기에 tallybot.js 파일의 내용을 붙여넣습니다.
3.  봇 관리자 페이지에서 추가한 봇의 새로고침 모양 아이콘을 눌러 컴파일한 뒤, 활성화 스위치를 켭니다.
4.  스크립트가 로드되면, 메시지가 발생할 때마다 `onMessage` 리스너가, 세미콜론(;)이 앞에 붙은 메시지가 발생할 때마다 `onCommand` 리스너가 동작합니다.

## 사용하는 백엔드 API 엔드포인트 📡

이 챗봇 스크립트는 아래의 백엔드 API와 통신하여 기능을 수행합니다.

**백엔드 서버 주소:** `http://tally-bot-web-backend-alb-243058276.ap-northeast-2.elb.amazonaws.com`

1.  **그룹 및 사용자 생성/조회**
    * `POST /api/group/create`
    * 메시지가 발생한 채팅방과 사용자 정보를 서버에 전송하여 고유 ID를 부여받습니다.

2.  **채팅 내용 업로드**
    * `POST /api/chat/upload`
    * 사용자의 메시지 내용, 발신자, 시간 등을 서버에 전송하여 기록합니다.

3.  **정산 프로세스 시작**
    * `POST /api/calculate/start`
    * 사용자가 요청한 정산 기간을 서버에 전송하여 계산 프로세스를 시작시킵니다.

5.  **정산 요약 결과 조회**
    * `GET /api/calculate/{calculateId}/brief-result`
    * 정산 시작 요청 후 받은 `calculateId`를 이용해, 계산이 완료되었는지 주기적으로 확인하고 완료 시 요약 결과를 가져옵니다.

## 프로젝트 구조 🏗️

본 프로젝트는 단일 스크립트 파일로 구성되어 있으며, 주요 함수와 이벤트 리스너는 다음과 같습니다.

tally-bot-script.js
│
├── 전역 변수 및 설정
│   ├── bot: 현재 봇 인스턴스
│   └── domain: 백엔드 서버 주소
│
├── 이벤트 리스너
│   ├── onMessage(msg): 모든 메시지를 수신하여 처리하는 메인 핸들러
│   │   - 일반 메시지 -> 채팅 업로드
│   │   - '정산' 키워드 -> onCommand 호출
│   └── onCommand(msg): ; 접두사 또는 특정 키워드로 호출되는 명령어 핸들러
│       - 정산 명령어 처리 로직
│
├── 핵심 함수
│   ├── sendJson(apiPath, json): 백엔드 서버로 POST 요청을 전송하고 응답을 JSON으로 파싱
│   ├── userCreateAndSelect(msg): 채팅방/사용자 정보를 서버에 보내고 그룹 정보를 반환
│   ├── makeTimestamp(): 한국 시간 기준 타임스탬프 생성
│   └── findMemberId(group, name): 그룹 정보에서 특정 이름의 멤버 ID를 검색
│
└── Android 액티비티 리스너 (부가 기능)
├── onCreate(activity): 봇 스크립트 로드 시 초기화
└── onStart, onResume 등...


## 사용 예시 💡

1.  **키워드로 정산 요청하기**

    > **사용자:** 우리 어제 먹은 거 6월 23일부터 6월 24일까지 정산해줘

    봇이 `6월 23일`과 `6월 24일`, 그리고 `정산` 키워드를 감지하여 자동으로 정산을 시작하고 아래와 같이 응답합니다.

    > **Tally Bot:** 정산을 수행하고 있습니다. 잠시만 기다려 주십시오.

2.  **명령어로 정산 요청하기**

    > **사용자:** ;정산 25062300 25062423

    봇이 명령어를 해석하여 2025년 6월 23일 00시부터 2025년 6월 24일 23시까지의 정산을 시작합니다.

3.  **정산 결과 받기**

    정산이 완료되면 봇이 결과 메시지를 보냅니다.

    > **Tally Bot:**
    > 정산이 완료되었습니다.
    >
    > **정산 결과**
    > 지훈 -> 준호: 15000원
    > 소연 -> 준호: 22000원
    >
    > 이 정산의 세부 내용을 보려면? https://tallybot.vercel.app/.../settlements/...
    > 채팅방 전체 정산 기록을 보려면? https://tallybot.vercel.app/...

## 의존성 📦

* **메신저봇R API**: `BotManager`, `Event.MESSAGE` 등 봇의 핵심 기능과 이벤트 처리를 위한 플랫폼 종속적인 API
* **Jsoup**: `org.jsoup.Jsoup` 자바 라이브러리. HTTP 통신을 위해 사용되며, 메신저봇R의 하위 의존성이므로 별도로 구성할 필요가 없습니다.

## 문제 해결 🔧

* **연결 오류**: 스크립트가 실행되는 기기의 인터넷 연결 상태를 확인하세요. `domain` 변수에 설정된 백엔드 서버 주소가 올바른지 확인하세요.
* **서버 오류**: 봇이 "서버 오류가 발생했습니다."라고 응답하는 경우, 백엔드 서버의 문제일 가능성이 높습니다. 서버 로그 확인이 필요합니다.
* **멤버 정보를 찾을 수 없음**: 봇이 사용자를 정상적으로 인식하지 못했을 때 발생합니다. 봇을 재시작하거나, 백엔드 `api/group/create` API가 정상 동작하는지 확인해야 합니다.
* **정산 처리 시간이 초과되었습니다**: 백엔드 서버에서 정산 계산에 60초 이상 소요될 때 발생합니다. 잠시 후 다시 시도하거나, 데이터가 너무 많을 경우 기간을 나누어 요청해 보세요.
