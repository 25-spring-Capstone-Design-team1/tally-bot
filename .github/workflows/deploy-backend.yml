name: Deploy Backend to EC2

on:
  push:
    branches:
      - dev
    paths:
      - 'api-backend/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.AWS_SSH_KEY }}

      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }} << 'EOF'
            cd /home/ssm-user/app/tally-bot/api-backend/tallybot_back

            echo "üì• [1] ÏµúÏã† ÏΩîÎìú Í∞ïÏ†ú ÎèôÍ∏∞Ìôî"
            git fetch origin
            git reset --hard origin/dev
            git clean -fd

            echo "üî® [2] ÎπåÎìú Ïã§Ìñâ"
            ./gradlew clean build -x test --no-build-cache

            echo "üõë [3] Í∏∞Ï°¥ Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò Ï¢ÖÎ£å"
            if [ -f app.pid ]; then
              kill -9 \$(cat app.pid) || true
              rm -f app.pid
            fi
            pkill -f 'tallybot_back' || true
            sleep 3

            echo "üöÄ [4] ÏÉà Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò Ïã§Ìñâ"
            nohup java -jar ./build/libs/tallybot_back-0.0.1-SNAPSHOT.jar \
              --spring.profiles.active=rds > app.log 2>&1 &
            echo \$! > app.pid
            sleep 10

            echo "‚úÖ [5] Ìó¨Ïä§ Ï≤¥ÌÅ¨"
            curl -f http://localhost:8080/app || echo "‚ö†Ô∏è Health check failed"

            echo "üß™ [6] ÌÖåÏä§Ìä∏ ÏãúÎÇòÎ¶¨Ïò§ Ïã§Ìñâ"
            BASE_URL="http://${{ secrets.AWS_HOST }}:8080"

            curl -X POST "\$BASE_URL/api/group/create" -H "Content-Type: application/json" -d '{
              "groupId": 2,
              "groupName": "ÌÖåÏä§Ìä∏ Í∑∏Î£π",
              "member": "ÏßÄÌõà"
            }'
            echo

            curl -X POST "\$BASE_URL/api/group/create" -H "Content-Type: application/json" -d '{
              "groupId": 2,
              "groupName": "ÌÖåÏä§Ìä∏ Í∑∏Î£π",
              "member": "Ï§ÄÌò∏"
            }'
            echo

            curl -X POST "\$BASE_URL/api/group/create" -H "Content-Type: application/json" -d '{
              "groupId": 2,
              "groupName": "ÌÖåÏä§Ìä∏ Í∑∏Î£π",
              "member": "ÎØºÏßÄ"
            }'
            echo

            curl -X POST "\$BASE_URL/api/group/create" -H "Content-Type: application/json" -d '{
              "groupId": 2,
              "groupName": "ÌÖåÏä§Ìä∏ Í∑∏Î£π",
              "member": "ÏàòÎπà"
            }'
            echo

            curl -X POST "\$BASE_URL/api/chat/upload" -H "Content-Type: application/json" -d '[
              {
                "groupId": 2,
                "timestamp": "2025-05-30 13:20:00",
                "memberId": 4,
                "message": "Ï†ïÏÇ∞ „Ñ±"
              },
              {
                "groupId": 2,
                "timestamp": "2025-05-30 13:21:00",
                "memberId": 5,
                "message": "ÎÇ¥Í∞Ä ÎÇºÍ≤å"
              }
            ]'
            echo

            curl -X POST "\$BASE_URL/api/calculate/start" -H "Content-Type: application/json" -d '{
              "groupId": 2,
              "startTime": "2025-05-30 13:00:00",
              "endTime": "2025-05-30 14:00:00"
            }'
            echo

            curl "\$BASE_URL/api/group/2/calculates"
            echo
            curl "\$BASE_URL/api/calculate/4/settlements"
            echo
            curl "\$BASE_URL/api/calculate/4/transfers"
            echo

            curl -X POST "\$BASE_URL/api/update/settlement" -H "Content-Type: application/json" -d '{
              "calculateId": 4,
              "settlementId": 11,
              "field": "update",
              "newValue": {
                "place": "Ïä§ÌÉÄÎ≤ÖÏä§"
              }
            }'
            echo

            curl -X POST "\$BASE_URL/api/update/settlement" -H "Content-Type: application/json" -d '{
              "calculateId": 4,
              "settlementId": 10,
              "field": "update",
              "newValue": {
                "amount": 12000
              }
            }'
            echo

            curl -X POST "\$BASE_URL/api/update/settlement" -H "Content-Type: application/json" -d '{
              "calculateId": 4,
              "settlementId": 10,
              "field": "update",
              "newValue": {
                "payer": 5
              }
            }'
            echo

            curl -X POST "\$BASE_URL/api/update/settlement" -H "Content-Type: application/json" -d '{
              "calculateId": 4,
              "settlementId": 10,
              "field": "update",
              "newValue": {
                "participants": [4, 5, 6]
              },
              "constants": {
                "4": 0,
                "5": 0,
                "6": 0
              },
              "ratios": {
                "4": 1,
                "5": 2,
                "6": 1
              },
              "sum": 4
            }'
            echo

            curl -X POST "\$BASE_URL/api/calculate/recalculate" -H "Content-Type: application/json" -d '{
              "calculateId": 4
            }'
            echo

            curl -X POST "\$BASE_URL/api/calculate/complete" -H "Content-Type: application/json" -d '{
              "calculateId": 4
            }'
            echo

            curl "\$BASE_URL/api/calculate/4/brief-result"
            echo
          EOF
