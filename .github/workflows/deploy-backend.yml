name: Deploy Backend to EC2

on:
  push:
    branches:
      - dev
    paths:
      - 'api-backend/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.AWS_SSH_KEY }}

      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }} << 'EOF'
            cd /home/ssm-user/app/tally-bot/api-backend/tallybot_back

            echo "ğŸ“¥ [1] ìµœì‹  ì½”ë“œ ê°•ì œ ë™ê¸°í™”"
            git fetch origin
            git reset --hard origin/dev
            git clean -fd

            echo "ğŸ”¨ [2] ê¸°ì¡´ ë¹Œë“œ ê²°ê³¼ ì œê±° ë° ì¬ë¹Œë“œ"
            rm -rf build/
            ./gradlew clean build -x test

            echo "ğŸ” [3] ë¹Œë“œëœ JAR í™•ì¸"
            ls -alh ./build/libs

            echo "ğŸ›‘ [4] ê¸°ì¡´ ëª¨ë“  Java í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ"
            pkill -f 'java' || true
            sleep 3

            echo "ğŸš€ [5] ìƒˆ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰"
            JAR_FILE=$(ls ./build/libs/*.jar | grep 'tallybot_back' | head -n 1)
            nohup java -jar "$JAR_FILE" --spring.profiles.active=rds > app.log 2>&1 &
            echo \$! > app.pid
            sleep 10

            echo "âœ… [6] í—¬ìŠ¤ ì²´í¬"
            curl -f http://localhost:8080/app || echo "âš ï¸ Health check failed"

            echo "ğŸ§ª [7] í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ ì‹¤í–‰"
            BASE_URL="http://${{ secrets.AWS_HOST }}:8080"

            curl -X POST "\$BASE_URL/api/group/create" -H "Content-Type: application/json" -d '{
              "groupId": 3,
              "groupName": "í…ŒìŠ¤íŠ¸ ê·¸ë£¹",
              "member": "ì§€í›ˆ"
            }'
            echo

            curl -X POST "\$BASE_URL/api/group/create" -H "Content-Type: application/json" -d '{
              "groupId": 3,
              "groupName": "í…ŒìŠ¤íŠ¸ ê·¸ë£¹",
              "member": "ì¤€í˜¸"
            }'
            echo

            curl -X POST "\$BASE_URL/api/chat/upload" -H "Content-Type: application/json" -d '[
              {
                "groupId": 3,
                "timestamp": "2025-05-30 13:20:00",
                "memberId": 4,
                "message": "ì •ì‚° ã„±"
              },
              {
                "groupId": 3,
                "timestamp": "2025-05-30 13:21:00",
                "memberId": 5,
                "message": "5000ì›ì„"
              }
            ]'
            echo

            curl -X POST "\$BASE_URL/api/calculate/start" -H "Content-Type: application/json" -d '{
              "groupId": 3,
              "startTime": "2025-05-30 13:00:00",
              "endTime": "2025-05-30 14:00:00"
            }'
            echo
          EOF
