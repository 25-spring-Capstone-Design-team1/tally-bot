name: Deploy Backend to EC2

on:
  push:
    branches:
      - dev
    paths:
      - 'api-backend/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.AWS_SSH_KEY }}

      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }} << 'EOF'
            cd /home/ssm-user/app/tally-bot/api-backend/tallybot_back

            echo "üì• [1] ÏµúÏã† ÏΩîÎìú Í∞ïÏ†ú ÎèôÍ∏∞Ìôî"
            git fetch origin
            git reset --hard origin/dev
            git clean -fd

            echo "üî® [2] ÎπåÎìú Ïã§Ìñâ"
            ./gradlew clean build -x test --no-build-cache

            echo "üõë [3] Í∏∞Ï°¥ Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò Ï¢ÖÎ£å"
            if [ -f app.pid ]; then
              kill -9 \$(cat app.pid) || true
              rm -f app.pid
            fi
            pkill -f 'tallybot_back' || true
            sleep 3

            echo "üöÄ [4] ÏÉà Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò Ïã§Ìñâ"
            nohup java -jar ./build/libs/tallybot_back-0.0.1-SNAPSHOT.jar \
              --spring.profiles.active=rds > app.log 2>&1 &

            echo \$! > app.pid
            sleep 10

            echo "‚úÖ [5] Ìó¨Ïä§ Ï≤¥ÌÅ¨"
            curl -f http://localhost:8080/app || echo "‚ö†Ô∏è Health check failed"

          EOF
